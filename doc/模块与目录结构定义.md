# 模块与目录结构定义

## 一、整体项目结构

### 1.1 Maven多模块结构

本项目采用Maven多模块结构，便于模块化管理与依赖管理。

```
problem-to-hero-backend/
├── doc/                          # 文档目录
│   ├── 开发方案.md
│   ├── 功能需求优先级.md
│   ├── 第一阶段框架搭建计划.md
│   ├── 模块与目录结构定义.md
│   └── 开发规范.md
├── common/                       # 公共模块目录
│   ├── common-core/             # 核心公共模块
│   ├── common-security/         # 安全公共模块
│   ├── common-web/              # Web公共模块
│   └── common-dbservice/        # 数据库服务模块（DAO层公共模块）
├── gateway/                      # API网关目录
│   └── api-gateway/              # 网关服务
├── services/                     # 业务服务目录
│   ├── user-service/             # 用户服务
│   ├── content-service/          # 内容服务
│   ├── activity-service/        # 活动服务
│   ├── wallet-service/           # 钱包服务
│   ├── search-service/           # 搜索服务
│   ├── notify-service/           # 通知服务
│   └── interaction-service/     # 互动服务
├── sql/                          # SQL脚本目录
│   ├── init.sql                  # 初始化脚本
│   └── update/                   # 更新脚本
├── docker-compose.yml            # Docker Compose配置
├── pom.xml                       # 父POM文件
├── .gitignore                    # Git忽略配置
└── README.md                     # 项目说明文档
```

### 1.2 父POM配置

父POM（`pom.xml`）负责：
- 统一管理依赖版本
- 定义子模块
- 配置构建插件
- 统一编码和Java版本

---

## 二、公共模块详细结构

### 2.1 common-core（核心公共模块）

**模块职责**：提供通用常量、枚举、异常、工具类等核心功能

```
common-core/
├── pom.xml
└── src/
    └── main/
        ├── java/
        │   └── com/
        │       └── sia/
        │           └── common/
        │               └── core/
        │                   ├── constant/                    # 常量类
        │                   │   ├── CommonConstants.java    # 通用常量
        │                   │   ├── DateConstants.java      # 日期常量
        │                   │   └── RegexConstants.java     # 正则表达式常量
        │                   ├── enum/                       # 枚举类
        │                   │   ├── ResultCodeEnum.java     # 响应码枚举
        │                   │   ├── YesNoEnum.java          # 是否枚举
        │                   │   └── StatusEnum.java          # 状态枚举
        │                   ├── exception/                  # 异常类
        │                   │   ├── BaseException.java      # 基础异常
        │                   │   ├── BusinessException.java  # 业务异常
        │                   │   └── SystemException.java    # 系统异常
        │                   ├── util/                       # 工具类
        │                   │   ├── DateUtil.java          # 日期工具
        │                   │   ├── StringUtil.java        # 字符串工具
        │                   │   ├── CollectionUtil.java    # 集合工具
        │                   │   └── JsonUtil.java          # JSON工具
        │                   └── id/                         # ID生成器
        │                       ├── IdGenerator.java        # ID生成器接口
        │                       └── SnowflakeIdGenerator.java # 雪花算法ID生成器
        └── resources/
            └── META-INF/
                └── spring.factories                        # Spring Boot自动配置
```

**核心类说明**：
- `SnowflakeIdGenerator`：雪花算法ID生成器，保证分布式环境下ID唯一性
- `ResultCodeEnum`：统一响应码枚举
- `BusinessException`：业务异常基类

### 2.2 common-security（安全公共模块）

**模块职责**：提供安全认证相关功能，包括JWT、密码加密等

```
common-security/
├── pom.xml
└── src/
    └── main/
        ├── java/
        │   └── com/
        │       └── sia/
        │           └── common/
        │               └── security/
        │                   ├── jwt/                         # JWT相关
        │                   │   ├── JwtUtil.java            # JWT工具类
        │                   │   ├── JwtClaims.java          # JWT Claims
        │                   │   └── JwtProperties.java      # JWT配置属性
        │                   ├── password/                   # 密码加密
        │                   │   └── PasswordEncoder.java    # 密码加密工具
        │                   └── config/                     # 安全配置
        │                       └── SecurityConfig.java     # 安全配置类
        └── resources/
            └── application-security.yml                    # 安全相关配置
```

**核心类说明**：
- `JwtUtil`：JWT Token生成与验证工具
- `PasswordEncoder`：密码加密工具（BCrypt）

### 2.3 common-web（Web公共模块）

**模块职责**：提供Web层通用功能，包括统一响应、异常处理、拦截器等

```
common-web/
├── pom.xml
└── src/
    └── main/
        ├── java/
        │   └── com/
        │       └── sia/
        │           └── common/
        │               └── web/
        │                   ├── result/                     # 统一响应
        │                   │   ├── Result.java            # 统一响应类
        │                   │   └── ResultBuilder.java     # 响应构建器
        │                   ├── exception/                 # 异常处理
        │                   │   ├── GlobalExceptionHandler.java # 全局异常处理器
        │                   │   └── ExceptionAdvice.java  # 异常通知
        │                   ├── interceptor/               # 拦截器
        │                   │   ├── LogInterceptor.java   # 日志拦截器
        │                   │   └── AuthInterceptor.java   # 认证拦截器
        │                   ├── validation/                # 参数验证
        │                   │   └── ValidatorUtil.java    # 验证工具
        │                   └── annotation/                # 注解
        │                       ├── NoAuth.java            # 无需认证注解
        │                       └── RateLimit.java         # 限流注解
        └── resources/
            └── META-INF/
                └── spring.factories
```

**核心类说明**：
- `Result<T>`：统一响应格式
- `GlobalExceptionHandler`：全局异常处理器
- `LogInterceptor`：日志拦截器

### 2.4 common-dbservice（数据库服务模块）

**模块职责**：提供数据库访问层（DAO层）的公共配置和基础功能

```
common-dbservice/
├── pom.xml
└── src/
    └── main/
        ├── java/
        │   └── com/
        │       └── sia/
        │           └── common/
        │               └── dbservice/
        │                   ├── config/                        # MyBatis配置
        │                   │   ├── MyBatisConfig.java        # MyBatis配置类
        │                   │   ├── DataSourceConfig.java    # 数据源配置
        │                   │   └── PageConfig.java           # 分页配置
        │                   ├── base/                          # 基础Mapper
        │                   │   └── BaseMapper.java           # 扩展BaseMapper
        │                   ├── handler/                       # 类型处理器
        │                   │   ├── LocalDateTimeTypeHandler.java # 日期时间处理器
        │                   │   └── JsonTypeHandler.java     # JSON处理器
        │                   └── interceptor/                  # MyBatis拦截器
        │                       ├── PageInterceptor.java      # 分页拦截器
        │                       └── SqlLogInterceptor.java   # SQL日志拦截器
        └── resources/
            └── META-INF/
                └── spring.factories                           # Spring Boot自动配置
```

**核心类说明**：
- `MyBatisConfig`：MyBatis-Plus配置，包括分页插件、乐观锁等
- `BaseMapper<T>`：扩展MyBatis-Plus的BaseMapper，添加自定义方法
- `PageInterceptor`：分页拦截器，统一分页处理
- `SqlLogInterceptor`：SQL日志拦截器，用于开发环境SQL调试

**使用方式**：
业务服务通过Maven依赖引入：
```xml
<dependency>
    <groupId>com.sia</groupId>
    <artifactId>common-dbservice</artifactId>
    <version>1.0.0</version>
</dependency>
```

**Mapper接口示例**：
```java
@Mapper
public interface UserMapper extends BaseMapper<User> {
    // 继承BaseMapper后，自动拥有CRUD方法
    // 复杂查询可自定义方法，使用XML或注解
    List<User> selectUsersByCondition(@Param("status") Integer status);
}
```

**优势**：
- ✅ **统一配置**：MyBatis-Plus配置、数据源配置等统一管理
- ✅ **代码复用**：BaseMapper、类型处理器、拦截器等可复用
- ✅ **易于维护**：数据库相关配置集中管理，修改方便
- ✅ **版本统一**：MyBatis-Plus、数据库驱动等依赖版本统一
- ✅ **减少重复**：避免每个业务服务重复配置DAO层

---

## 三、网关模块结构

### 3.1 api-gateway（API网关）

**模块职责**：API网关，负责路由转发、统一鉴权、跨域处理、限流熔断

```
api-gateway/
├── pom.xml
└── src/
    └── main/
        ├── java/
        │   └── com/
        │       └── sia/
        │           └── gateway/
        │               ├── GatewayApplication.java        # 启动类
        │               ├── config/                        # 配置类
        │               │   ├── GatewayConfig.java        # 网关配置
        │               │   ├── CorsConfig.java           # 跨域配置
        │               │   └── RateLimitConfig.java      # 限流配置
        │               ├── filter/                        # 过滤器
        │               │   ├── JwtAuthFilter.java        # JWT认证过滤器
        │               │   ├── LogFilter.java            # 日志过滤器
        │               │   └── RateLimitFilter.java      # 限流过滤器
        │               ├── handler/                      # 处理器
        │               │   ├── GatewayExceptionHandler.java # 网关异常处理
        │               │   └── FallbackHandler.java     # 降级处理
        │               └── util/                          # 工具类
        │                   └── RouteUtil.java             # 路由工具
        └── resources/
            └── application.yml                           # 网关配置
```

**核心配置**：
- 路由规则配置
- 服务发现配置
- 限流规则配置
- 熔断规则配置

---

## 四、业务服务通用结构

### 4.1 服务分层架构

每个业务服务采用**三层架构**：
- **API层（Controller）**：接收HTTP请求，参数验证
- **Service层**：业务逻辑处理，事务管理
- **DAO层（Mapper）**：数据库操作

### 4.2 user-service（用户服务）示例

```
user-service/
├── pom.xml
└── src/
    └── main/
        ├── java/
        │   └── com/
        │       └── sia/
        │           └── user/
        │               ├── UserServiceApplication.java    # 启动类
        │               ├── api/                           # API层
        │               │   └── controller/
        │               │       ├── UserController.java   # 用户控制器
        │               │       └── AuthController.java   # 认证控制器
        │               ├── service/                       # Service层
        │               │   ├── UserService.java          # 用户服务接口
        │               │   ├── AuthService.java          # 认证服务接口
        │               │   └── impl/
        │               │       ├── UserServiceImpl.java  # 用户服务实现
        │               │       └── AuthServiceImpl.java  # 认证服务实现
        │               ├── dao/                           # DAO层
        │               │   └── mapper/
        │               │       ├── UserMapper.java      # 用户Mapper
        │               │       └── UserProfileMapper.java # 用户资料Mapper
        │               ├── entity/                        # 实体类
        │               │   ├── User.java                  # 用户实体
        │               │   └── UserProfile.java           # 用户资料实体
        │               ├── dto/                           # 数据传输对象
        │               │   ├── request/
        │               │   │   ├── UserCreateDTO.java    # 创建用户DTO
        │               │   │   ├── UserUpdateDTO.java    # 更新用户DTO
        │               │   │   └── LoginDTO.java          # 登录DTO
        │               │   └── response/
        │               │       ├── UserVO.java           # 用户视图对象
        │               │       └── LoginVO.java          # 登录响应VO
        │               ├── vo/                            # 视图对象（可选，与dto/response合并）
│               ├── config/                        # 配置类（服务特定配置）
│               │   └── RedisConfig.java          # Redis配置（如需要）
│               │   # 注意：MyBatis配置已在common-dbservice中统一配置
        │               └── constant/                      # 常量（服务内）
        │                   └── UserConstants.java         # 用户相关常量
        └── resources/
            ├── mapper/                                    # MyBatis Mapper XML
            │   ├── UserMapper.xml
            │   └── UserProfileMapper.xml
            ├── application.yml                           # 应用配置
            ├── application-dev.yml                       # 开发环境配置
            ├── application-test.yml                      # 测试环境配置
            └── application-prod.yml                      # 生产环境配置
```

### 4.3 content-service（内容服务）示例

```
content-service/
├── pom.xml
└── src/
    └── main/
        ├── java/
        │   └── com/
        │       └── sia/
        │           └── content/
        │               ├── ContentServiceApplication.java
        │               ├── api/
        │               │   └── controller/
        │               │       ├── QuestionController.java    # 问题控制器
        │               │       ├── AnswerController.java     # 回答控制器
        │               │       └── CommentController.java    # 评论控制器
        │               ├── service/
        │               │   ├── QuestionService.java
        │               │   ├── AnswerService.java
        │               │   ├── CommentService.java
        │               │   └── impl/
        │               │       ├── QuestionServiceImpl.java
        │               │       ├── AnswerServiceImpl.java
        │               │       └── CommentServiceImpl.java
        │               ├── dao/
        │               │   └── mapper/
        │               │       ├── QuestionMapper.java
        │               │       ├── AnswerMapper.java
        │               │       └── CommentMapper.java
        │               ├── entity/
        │               │   ├── Question.java
        │               │   ├── Answer.java
        │               │   └── Comment.java
        │               └── dto/
        │                   ├── request/
        │                   │   ├── QuestionCreateDTO.java
        │                   │   └── AnswerCreateDTO.java
        │                   └── response/
        │                       ├── QuestionVO.java
        │                       └── AnswerVO.java
        └── resources/
            ├── mapper/
            │   ├── QuestionMapper.xml
            │   └── AnswerMapper.xml
            └── application.yml
```

### 4.4 其他业务服务

其他业务服务（activity-service、wallet-service、search-service、notify-service、interaction-service）的结构与user-service类似，遵循相同的分层架构和目录规范。

---

## 五、命名规范

### 5.1 包命名规范

| 层级 | 规范 | 示例 |
|------|------|------|
| **根包名** | `com.sia` | - |
| **模块包名** | `com.sia.{module}` | `com.sia.user`、`com.sia.content` |
| **公共模块包名** | `com.sia.common.{module}` | `com.sia.common.core` |
| **网关包名** | `com.sia.gateway` | - |
| **子包名** | 全小写，点分隔 | `com.sia.user.api.controller` |

### 5.2 类命名规范

| 类型 | 规范 | 示例 |
|------|------|------|
| **类名** | 大驼峰（PascalCase） | `UserController`、`UserService` |
| **接口名** | 大驼峰，通常不加I前缀 | `UserService`、`UserMapper` |
| **实现类** | 大驼峰 + Impl后缀 | `UserServiceImpl` |
| **实体类** | 大驼峰，对应数据库表 | `User`、`Question` |
| **DTO类** | 大驼峰 + DTO后缀 | `UserCreateDTO`、`UserUpdateDTO` |
| **VO类** | 大驼峰 + VO后缀 | `UserVO`、`QuestionVO` |
| **枚举类** | 大驼峰 + Enum后缀 | `ResultCodeEnum`、`StatusEnum` |
| **异常类** | 大驼峰 + Exception后缀 | `BusinessException`、`UserNotFoundException` |
| **配置类** | 大驼峰 + Config后缀 | `MyBatisConfig`、`RedisConfig` |
| **工具类** | 大驼峰 + Util后缀 | `DateUtil`、`StringUtil` |

### 5.3 方法命名规范

| 类型 | 规范 | 示例 |
|------|------|------|
| **查询方法** | `get`、`find`、`query`、`list` | `getUserById`、`findUsersByStatus` |
| **创建方法** | `create`、`add`、`save` | `createUser`、`addQuestion` |
| **更新方法** | `update`、`modify` | `updateUser`、`modifyQuestion` |
| **删除方法** | `delete`、`remove` | `deleteUser`、`removeQuestion` |
| **判断方法** | `is`、`has`、`exists` | `isUserExists`、`hasPermission` |
| **转换方法** | `convert`、`to` | `convertToVO`、`toDTO` |

### 5.4 变量命名规范

| 类型 | 规范 | 示例 |
|------|------|------|
| **普通变量** | 小驼峰（camelCase） | `userId`、`userName` |
| **常量** | 全大写下划线分隔（UPPER_SNAKE_CASE） | `MAX_RETRY_COUNT`、`DEFAULT_PAGE_SIZE` |
| **静态常量** | 全大写下划线分隔 | `API_VERSION`、`TOKEN_HEADER` |
| **集合变量** | 复数形式 | `users`、`questions`、`userList` |
| **布尔变量** | `is`、`has`、`can`前缀 | `isDeleted`、`hasPermission`、`canEdit` |

### 5.5 数据库命名规范

| 类型 | 规范 | 示例 |
|------|------|------|
| **表名** | 小写下划线分隔，单数或业务含义 | `user`、`user_info`、`question` |
| **字段名** | 小写下划线分隔 | `user_id`、`create_time`、`is_deleted` |
| **主键** | 统一使用`id` | `id` |
| **外键** | `{table}_id` | `user_id`、`question_id` |
| **时间字段** | `{action}_time` | `create_time`、`update_time`、`delete_time` |
| **布尔字段** | `is_{description}` | `is_deleted`、`is_active`、`is_verified` |

---

## 六、目录层级说明

### 6.1 API层（Controller层）

**职责**：
- 接收HTTP请求
- 参数验证（使用`@Valid`）
- 调用Service层
- 返回统一响应格式

**示例**：
```java
@RestController
@RequestMapping("/api/users")
public class UserController {
    
    @Autowired
    private UserService userService;
    
    @GetMapping("/{id}")
    public Result<UserVO> getUserById(@PathVariable Long id) {
        UserVO user = userService.getUserById(id);
        return Result.success(user);
    }
    
    @PostMapping
    public Result<UserVO> createUser(@Valid @RequestBody UserCreateDTO userDTO) {
        UserVO user = userService.createUser(userDTO);
        return Result.success(user);
    }
}
```

### 6.2 Service层

**职责**：
- 业务逻辑处理
- 事务管理（使用`@Transactional`）
- 调用DAO层
- 调用其他服务（通过Feign）

**示例**：
```java
@Service
@Transactional(rollbackFor = Exception.class)
public class UserServiceImpl implements UserService {
    
    @Autowired
    private UserMapper userMapper;
    
    @Override
    public UserVO getUserById(Long id) {
        User user = userMapper.selectById(id);
        if (user == null) {
            throw new UserNotFoundException("用户不存在");
        }
        return convertToVO(user);
    }
    
    @Override
    public UserVO createUser(UserCreateDTO userDTO) {
        // 业务逻辑处理
        User user = convertToEntity(userDTO);
        userMapper.insert(user);
        return convertToVO(user);
    }
}
```

### 6.3 DAO层（Mapper层）

**职责**：
- 数据库操作
- SQL映射（使用MyBatis-Plus或XML）

**示例**：
```java
@Mapper
public interface UserMapper extends BaseMapper<User> {
    
    // 使用MyBatis-Plus内置方法
    // 复杂查询使用XML
    List<User> selectUsersByCondition(@Param("status") Integer status);
}
```

---

## 七、配置文件结构

### 7.1 配置文件层级

```
resources/
├── application.yml              # 主配置文件
├── application-dev.yml         # 开发环境配置
├── application-test.yml         # 测试环境配置
├── application-prod.yml         # 生产环境配置
└── mapper/                      # MyBatis Mapper XML
```

### 7.2 配置文件内容结构

**application.yml**（主配置）：
```yaml
spring:
  application:
    name: user-service
  profiles:
    active: dev
  # 其他公共配置
```

**application-dev.yml**（开发环境）：
```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/test_db
    username: root
    password: ${DB_PASSWORD:dev_password}
  redis:
    host: localhost
    port: 6379
```

**application-prod.yml**（生产环境）：
```yaml
spring:
  datasource:
    url: jdbc:mysql://${DB_HOST:localhost}:3306/${DB_NAME:prod_db}
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
  redis:
    host: ${REDIS_HOST}
    port: ${REDIS_PORT:6379}
```

### 7.3 配置管理原则

- 敏感信息使用环境变量
- 不同环境使用不同配置文件
- 公共配置放在主配置文件
- 环境特定配置放在对应环境配置文件

---

## 八、依赖关系

### 8.1 模块依赖关系

```
api-gateway
    └── common-web
            └── common-security
                    └── common-core

user-service
    └── common-web
            └── common-security
                    └── common-core

content-service
    └── common-web
            └── common-security
                    └── common-core

其他业务服务...
    └── common-web
            └── common-security
                    └── common-core
```

### 8.2 依赖原则

- 公共模块不依赖业务服务
- 业务服务可以依赖公共模块
- 网关可以依赖公共模块
- 业务服务之间不直接依赖，通过Feign调用

---

## 九、代码生成规范

### 9.1 实体类生成

- 使用MyBatis-Plus代码生成器
- 或使用MapStruct生成DTO/VO转换代码
- 实体类使用Lombok简化代码

### 9.2 统一代码模板

- Controller模板
- Service模板
- Mapper模板
- DTO/VO模板

---

## 十、注意事项

### 10.1 包结构注意事项

- 严格按照包结构组织代码
- 不要跨层调用（如Controller直接调用DAO）
- 公共代码放在common模块

### 10.2 命名注意事项

- 命名要有意义，见名知意
- 避免使用缩写（除非是通用缩写）
- 保持命名一致性

### 10.3 目录结构注意事项

- 每个服务保持相同的目录结构
- 新增模块时参考现有结构
- 保持代码组织清晰

---

*本文档定义了项目的模块与目录结构。*
