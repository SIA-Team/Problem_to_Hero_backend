# 模块与目录结构定义

**项目名称**：Problem to Hero Backend  
**基础框架**：基于 RuoYi-Cloud 改造  
**包名规范**：`com.sia.*`  
**模块名规范**：`qa-hero-*`  
**GroupId**：`com.sia`  
**ArtifactId**：`qa-hero`

## 一、整体项目结构

### 1.1 Maven多模块结构

本项目基于 **RuoYi-Cloud** 框架改造，采用Maven多模块结构，便于模块化管理与依赖管理。**所有代码与 Maven 模块均位于 `code/` 目录下**，SQL 脚本位于仓库根目录的 `sql/`。

```
problem-to-hero-backend/
├── code/                         # 代码与 Maven 工程目录
│   ├── pom.xml                   # 父POM文件 (groupId: com.sia, artifactId: qa-hero)
│   ├── qa-hero-gateway/          # API网关（双路由：/admin/api、/app/api）
│   ├── qa-hero-auth/             # 管理端认证服务（Admin-Token）
│   ├── qa-hero-modules/          # 业务模块目录
│   │   ├── qa-hero-system/       # 系统服务（管理端用户/角色/权限等）
│   │   ├── qa-hero-auth-app/     # 业务端认证服务（App-Token）⭐ 新增
│   │   ├── qa-hero-content/      # 内容服务（问答/评论等）⭐ 待创建
│   │   ├── qa-hero-activity/     # 活动服务 ⭐ 待创建
│   │   ├── qa-hero-gen/          # 代码生成
│   │   ├── qa-hero-job/          # 定时任务
│   │   └── qa-hero-file/         # 文件服务
│   ├── qa-hero-common/           # 公共模块目录
│   │   ├── qa-hero-common-core/  # 核心公共模块
│   │   ├── qa-hero-common-security/ # 安全公共模块
│   │   ├── qa-hero-common-redis/ # Redis公共模块
│   │   ├── qa-hero-common-log/   # 日志公共模块
│   │   ├── qa-hero-common-swagger/ # 接口文档模块
│   │   └── ...                   # 其他公共模块
│   ├── qa-hero-api/              # API接口模块目录
│   │   └── qa-hero-api-system/   # 系统API
│   └── qa-hero-visual/           # 可视化模块（监控等）
│       └── qa-hero-monitor/      # 监控中心
├── doc/                          # 文档目录
│   ├── 开发方案.md
│   ├── 开发规范.md
│   ├── 模块与目录结构定义.md
│   └── ...
├── sql/                          # SQL脚本目录（仓库根下）
│   ├── ry_cloud.sql              # 基础表（改造自RuoYi）
│   ├── ry_config_20250902.sql    # Nacos配置SQL
│   ├── app_user.sql              # 业务用户表 ⭐ 新增
│   └── qa_tables.sql             # 问答业务表 ⭐ 新增
├── reports/                      # 工作报告
├── docker-compose.yml
├── .gitignore
└── README.md
```

**说明**：
- 基于 RuoYi-Cloud 框架改造
- 模块名：`qa-hero-*`
- 包名：`com.sia.*`
- 新增业务端模块（qa-hero-auth-app、qa-hero-content 等）
- 管理端与业务端通过网关双路由隔离

### 1.2 父POM配置

父POM（`pom.xml`）负责：
- 统一管理依赖版本
- 定义子模块
- 配置构建插件
- 统一编码和Java版本

---

## 二、公共模块详细结构

### 2.1 qa-hero-common-core（核心公共模块）

**模块职责**：提供通用常量、异常、工具类、通用实体等核心功能

```
qa-hero-common-core/
├── pom.xml
└── src/
    └── main/
        ├── java/
        │   └── com/
        │       └── sia/
        │           └── common/
        │               └── core/
        │                   ├── constant/                    # 常量类
        │                   │   ├── CacheConstants.java     # 缓存常量
        │                   │   ├── ServiceNameConstants.java # 服务名常量
        │                   │   └── ...                      # 其他常量
        │                   ├── exception/                   # 异常类
        │                   │   ├── BaseException.java      # 基础异常
        │                   │   ├── ServiceException.java   # 服务异常
        │                   │   └── ...                      # 其他异常
        │                   ├── utils/                       # 工具类
        │                   │   ├── StringUtils.java        # 字符串工具
        │                   │   ├── DateUtils.java          # 日期工具
        │                   │   └── ...                      # 其他工具
        │                   ├── domain/                      # 通用实体
        │                   │   ├── AjaxResult.java         # 统一响应
        │                   │   ├── R.java                  # 泛型响应类
        │                   │   ├── TableDataInfo.java      # 分页响应
        │                   │   └── ...                      # 其他实体
        │                   ├── text/                        # 文本处理
        │                   └── web/                         # Web相关
        └── resources/
```

**核心类说明**：
- `AjaxResult`：统一响应格式
- `R<T>`：泛型响应类
- `ServiceException`：业务异常基类

### 2.2 common-security（安全公共模块）

**模块职责**：提供安全认证相关功能，包括JWT、密码加密等

```
common-security/
├── pom.xml
└── src/
    └── main/
        ├── java/
        │   └── com/
        │       └── sia/
        │           └── common/
        │               └── security/
        │                   ├── jwt/                         # JWT相关
        │                   │   ├── JwtUtil.java            # JWT工具类
        │                   │   ├── JwtClaims.java          # JWT Claims
        │                   │   └── JwtProperties.java      # JWT配置属性
        │                   ├── password/                   # 密码加密
        │                   │   └── PasswordEncoder.java    # 密码加密工具
        │                   └── config/                     # 安全配置
        │                       └── SecurityConfig.java     # 安全配置类
        └── resources/
            └── application-security.yml                    # 安全相关配置
```

**核心类说明**：
- `JwtUtil`：JWT Token生成与验证工具
- `PasswordEncoder`：密码加密工具（BCrypt）

### 2.3 common-web（Web公共模块）

**模块职责**：提供Web层通用功能，包括统一响应、异常处理、拦截器等

```
common-web/
├── pom.xml
└── src/
    └── main/
        ├── java/
        │   └── com/
        │       └── sia/
        │           └── common/
        │               └── web/
        │                   ├── result/                     # 统一响应
        │                   │   ├── Result.java            # 统一响应类
        │                   │   └── ResultBuilder.java     # 响应构建器
        │                   ├── exception/                 # 异常处理
        │                   │   ├── GlobalExceptionHandler.java # 全局异常处理器
        │                   │   └── ExceptionAdvice.java  # 异常通知
        │                   ├── interceptor/               # 拦截器
        │                   │   ├── LogInterceptor.java   # 日志拦截器
        │                   │   └── AuthInterceptor.java   # 认证拦截器
        │                   ├── validation/                # 参数验证
        │                   │   └── ValidatorUtil.java    # 验证工具
        │                   ├── annotation/                # 注解
        │                   │   ├── NoAuth.java            # 无需认证注解
        │                   │   └── RateLimit.java         # 限流注解
        │                   └── config/                    # Web 配置
        │                       └── WebMvcConfig.java     # MVC 配置（拦截器注册等）
        └── resources/
```

**核心类说明**：
- `Result<T>`：统一响应格式
- `GlobalExceptionHandler`：全局异常处理器
- `LogInterceptor`：日志拦截器

### 2.4 common-dbservice（数据库服务模块）

**模块职责**：提供数据库访问层（DAO层）的公共配置和基础功能

```
common-dbservice/
├── pom.xml
└── src/
    └── main/
        ├── java/
        │   └── com/
        │       └── sia/
        │           └── common/
        │               └── dbservice/
        │                   ├── config/                        # MyBatis配置
        │                   │   ├── MyBatisConfig.java        # MyBatis配置类
        │                   │   ├── DataSourceConfig.java    # 数据源配置
        │                   │   └── PageConfig.java           # 分页配置
        │                   ├── base/                          # 基础Mapper
        │                   │   └── BaseMapper.java           # 扩展BaseMapper
        │                   ├── handler/                       # 类型处理器
        │                   │   ├── LocalDateTimeTypeHandler.java # 日期时间处理器
        │                   │   └── JsonTypeHandler.java     # JSON处理器
        │                   └── interceptor/                  # MyBatis拦截器
        │                       ├── PageInterceptor.java      # 分页拦截器
        │                       └── SqlLogInterceptor.java   # SQL日志拦截器
        └── resources/
            └── META-INF/
                └── spring.factories                           # Spring Boot自动配置
```

**核心类说明**：
- `MyBatisConfig`：MyBatis-Plus配置，包括分页插件、乐观锁等
- `BaseMapper<T>`：扩展MyBatis-Plus的BaseMapper，添加自定义方法
- `PageInterceptor`：分页拦截器，统一分页处理
- `SqlLogInterceptor`：SQL日志拦截器，用于开发环境SQL调试

**使用方式**：
业务服务通过Maven依赖引入：
```xml
<dependency>
    <groupId>com.sia</groupId>
    <artifactId>common-dbservice</artifactId>
    <version>1.0.0</version>
</dependency>
```

**Mapper接口示例**：
```java
@Mapper
public interface UserMapper extends BaseMapper<User> {
    // 继承BaseMapper后，自动拥有CRUD方法
    // 复杂查询可自定义方法，使用XML或注解
    List<User> selectUsersByCondition(@Param("status") Integer status);
}
```

**优势**：
- ✅ **统一配置**：MyBatis-Plus配置、数据源配置等统一管理
- ✅ **代码复用**：BaseMapper、类型处理器、拦截器等可复用
- ✅ **易于维护**：数据库相关配置集中管理，修改方便
- ✅ **版本统一**：MyBatis-Plus、数据库驱动等依赖版本统一
- ✅ **减少重复**：避免每个业务服务重复配置DAO层

---

## 三、网关模块结构（ruoyi-gateway）

### 3.1 ruoyi-gateway（API网关 - 双路由）

**模块职责**：API网关，负责双路由转发、双Token鉴权、跨域处理、限流熔断

```
ruoyi-gateway/
├── pom.xml
└── src/
    └── main/
        ├── java/
        │   └── com/
        │       └── ruoyi/
        │           └── gateway/
        │               ├── RuoYiGatewayApplication.java   # 启动类
        │               ├── config/                        # 配置类
        │               │   └── SpringDocConfig.java      # 接口文档配置
        │               ├── filter/                        # 过滤器（需新增双鉴权）
        │               │   ├── AdminAuthFilter.java      # 管理端鉴权 ⭐ 新增
        │               │   ├── AppAuthFilter.java        # 业务端鉴权 ⭐ 新增
        │               │   ├── ValidateCodeFilter.java   # 验证码过滤器（RuoYi原有）
        │               │   └── AuthFilter.java           # 认证过滤器（RuoYi原有）
        │               ├── service/                       # 服务类
        │               │   └── ValidateCodeService.java  # 验证码服务
        │               └── handler/                       # 处理器
        │                   ├── GatewayExceptionHandler.java # 网关异常处理
        │                   └── ImageCodeHandler.java     # 图形验证码处理器
        └── resources/
            ├── bootstrap.yml                             # 启动配置（Nacos地址等）
            └── logback.xml                               # 日志配置
```

**核心配置**：
- **双路由规则**：
  - `/admin/api/**` → 管理端服务
  - `/app/api/**` → 业务端服务
- **双Token鉴权**：
  - 管理端验证 `Admin-Token`（Redis key: `admin:token:{token}`）
  - 业务端验证 `App-Token`（Redis key: `app:token:{token}`）
- **服务发现配置**：从 Nacos 读取服务列表
- **限流规则配置**：集成 Sentinel（可选）

---

## 四、业务服务通用结构

### 4.1 服务分层架构

每个业务服务采用**三层架构**：
- **API层（Controller）**：接收HTTP请求，参数验证
- **Service层**：业务逻辑处理，事务管理
- **DAO层（Mapper）**：数据库操作

### 4.2 ruoyi-auth-app（业务端认证服务）示例 ⭐ 核心新增

```
ruoyi-auth-app/
├── pom.xml
└── src/
    └── main/
        ├── java/
        │   └── com/
        │       └── ruoyi/
        │           └── auth/
        │               └── app/
        │                   ├── RuoYiAuthAppApplication.java  # 启动类
        │                   ├── controller/                   # Controller层
        │                   │   └── AppAuthController.java   # 业务端认证控制器
        │                   ├── service/                      # Service层
        │                   │   ├── AppAuthService.java      # 认证服务接口
        │                   │   └── impl/
        │                   │       └── AppAuthServiceImpl.java # 认证服务实现
        │                   ├── mapper/                       # Mapper层
        │                   │   └── AppUserMapper.java       # 业务用户Mapper
        │                   ├── domain/                       # 实体类
        │                   │   └── AppUser.java             # 业务用户实体
        │                   └── dto/                          # 数据传输对象
        │                       ├── RegisterDTO.java         # 注册DTO
        │                       ├── LoginDTO.java            # 登录DTO
        │                       └── LoginVO.java             # 登录响应VO
        └── resources/
            ├── mapper/                                      # MyBatis Mapper XML
            │   └── AppUserMapper.xml
            ├── bootstrap.yml                                # 启动配置（Nacos等）
            └── logback.xml                                  # 日志配置
```

**核心功能**：
- 业务用户注册/登录/登出
- App-Token 生成与管理
- Token 存储到 Redis（key: `app:token:{token}`）
- 用户信息获取与更新

### 4.3 ruoyi-content（内容服务）示例 ⭐ 待创建

```
ruoyi-content/
├── pom.xml
└── src/
    └── main/
        ├── java/
        │   └── com/
        │       └── ruoyi/
        │           └── content/
        │               ├── RuoYiContentApplication.java   # 启动类
        │               ├── controller/                     # Controller层
        │               │   ├── QuestionController.java    # 问题控制器
        │               │   ├── AnswerController.java      # 回答控制器
        │               │   └── CommentController.java     # 评论控制器
        │               ├── service/                        # Service层
        │               │   ├── IQuestionService.java      # 问题服务接口
        │               │   ├── IAnswerService.java        # 回答服务接口
        │               │   ├── ICommentService.java       # 评论服务接口
        │               │   └── impl/
        │               │       ├── QuestionServiceImpl.java
        │               │       ├── AnswerServiceImpl.java
        │               │       └── CommentServiceImpl.java
        │               ├── mapper/                         # Mapper层
        │               │   ├── QuestionMapper.java
        │               │   ├── AnswerMapper.java
        │               │   └── CommentMapper.java
        │               ├── domain/                         # 实体类
        │               │   ├── Question.java
        │               │   ├── Answer.java
        │               │   └── Comment.java
        │               └── dto/                            # 数据传输对象
        │                   ├── QuestionDTO.java
        │                   ├── AnswerDTO.java
        │                   └── CommentDTO.java
        └── resources/
            ├── mapper/                                     # MyBatis Mapper XML
            │   ├── QuestionMapper.xml
            │   ├── AnswerMapper.xml
            │   └── CommentMapper.xml
            ├── bootstrap.yml                               # 启动配置
            └── logback.xml                                 # 日志配置
```

### 4.4 其他业务服务

其他业务服务（content-service、activity-service、wallet-service、search-service、notify-service、interaction-service）与 user-service 采用**相同的分层包结构**：

- **API 层**：`api.controller`（Controller 类）
- **Service 层**：`service`（接口）、`service.impl`（实现类）
- **DAO 层**：`dao.mapper`（Mapper 接口）
- **实体与 DTO**：`entity`、`dto.request`、`dto.response`
- **服务内扩展**：`config`、`constant`
- **资源**：`resources/mapper/`（Mapper XML）

各包可通过 `package-info.java` 保留目录并注明职责，后续在对应包下新增业务类即可。

---

## 五、命名规范

### 5.1 包命名规范

| 层级 | 规范 | 示例 |
|------|------|------|
| **根包名** | `com.ruoyi` | - |
| **管理端模块包名** | `com.ruoyi.{module}` | `com.ruoyi.system`、`com.ruoyi.auth` |
| **业务端模块包名** | `com.ruoyi.{module}.app` | `com.ruoyi.auth.app`、`com.ruoyi.content.app` |
| **公共模块包名** | `com.ruoyi.common.{module}` | `com.ruoyi.common.core` |
| **API模块包名** | `com.ruoyi.api.{module}` | `com.ruoyi.api.system` |
| **网关包名** | `com.ruoyi.gateway` | - |
| **子包名** | 全小写，点分隔 | `com.ruoyi.auth.app.controller` |

### 5.2 类命名规范

| 类型 | 规范 | 示例 |
|------|------|------|
| **类名** | 大驼峰（PascalCase） | `UserController`、`UserService` |
| **接口名** | 大驼峰，通常不加I前缀 | `UserService`、`UserMapper` |
| **实现类** | 大驼峰 + Impl后缀 | `UserServiceImpl` |
| **实体类** | 大驼峰，对应数据库表 | `User`、`Question` |
| **DTO类** | 大驼峰 + DTO后缀 | `UserCreateDTO`、`UserUpdateDTO` |
| **VO类** | 大驼峰 + VO后缀 | `UserVO`、`QuestionVO` |
| **枚举类** | 大驼峰 + Enum后缀 | `ResultCodeEnum`、`StatusEnum` |
| **异常类** | 大驼峰 + Exception后缀 | `BusinessException`、`UserNotFoundException` |
| **配置类** | 大驼峰 + Config后缀 | `MyBatisConfig`、`RedisConfig` |
| **工具类** | 大驼峰 + Util后缀 | `DateUtil`、`StringUtil` |

### 5.3 方法命名规范

| 类型 | 规范 | 示例 |
|------|------|------|
| **查询方法** | `get`、`find`、`query`、`list` | `getUserById`、`findUsersByStatus` |
| **创建方法** | `create`、`add`、`save` | `createUser`、`addQuestion` |
| **更新方法** | `update`、`modify` | `updateUser`、`modifyQuestion` |
| **删除方法** | `delete`、`remove` | `deleteUser`、`removeQuestion` |
| **判断方法** | `is`、`has`、`exists` | `isUserExists`、`hasPermission` |
| **转换方法** | `convert`、`to` | `convertToVO`、`toDTO` |

### 5.4 变量命名规范

| 类型 | 规范 | 示例 |
|------|------|------|
| **普通变量** | 小驼峰（camelCase） | `userId`、`userName` |
| **常量** | 全大写下划线分隔（UPPER_SNAKE_CASE） | `MAX_RETRY_COUNT`、`DEFAULT_PAGE_SIZE` |
| **静态常量** | 全大写下划线分隔 | `API_VERSION`、`TOKEN_HEADER` |
| **集合变量** | 复数形式 | `users`、`questions`、`userList` |
| **布尔变量** | `is`、`has`、`can`前缀 | `isDeleted`、`hasPermission`、`canEdit` |

### 5.5 数据库命名规范

| 类型 | 规范 | 示例 |
|------|------|------|
| **表名** | 小写下划线分隔，单数或业务含义 | `user`、`user_info`、`question` |
| **字段名** | 小写下划线分隔 | `user_id`、`create_time`、`is_deleted` |
| **主键** | 统一使用`id` | `id` |
| **外键** | `{table}_id` | `user_id`、`question_id` |
| **时间字段** | `{action}_time` | `create_time`、`update_time`、`delete_time` |
| **布尔字段** | `is_{description}` | `is_deleted`、`is_active`、`is_verified` |

---

## 六、目录层级说明

### 6.1 API层（Controller层）

**职责**：
- 接收HTTP请求
- 参数验证（使用`@Valid`）
- 调用Service层
- 返回统一响应格式

**示例**：
```java
@RestController
@RequestMapping("/api/users")
public class UserController {
    
    @Autowired
    private UserService userService;
    
    @GetMapping("/{id}")
    public Result<UserVO> getUserById(@PathVariable Long id) {
        UserVO user = userService.getUserById(id);
        return Result.success(user);
    }
    
    @PostMapping
    public Result<UserVO> createUser(@Valid @RequestBody UserCreateDTO userDTO) {
        UserVO user = userService.createUser(userDTO);
        return Result.success(user);
    }
}
```

### 6.2 Service层

**职责**：
- 业务逻辑处理
- 事务管理（使用`@Transactional`）
- 调用DAO层
- 调用其他服务（通过Feign）

**示例**：
```java
@Service
@Transactional(rollbackFor = Exception.class)
public class UserServiceImpl implements UserService {
    
    @Autowired
    private UserMapper userMapper;
    
    @Override
    public UserVO getUserById(Long id) {
        User user = userMapper.selectById(id);
        if (user == null) {
            throw new UserNotFoundException("用户不存在");
        }
        return convertToVO(user);
    }
    
    @Override
    public UserVO createUser(UserCreateDTO userDTO) {
        // 业务逻辑处理
        User user = convertToEntity(userDTO);
        userMapper.insert(user);
        return convertToVO(user);
    }
}
```

### 6.3 Mapper层（DAO层）

**职责**：
- 数据库操作
- SQL映射（使用MyBatis或XML）

**示例**：
```java
@Mapper
public interface AppUserMapper {
    
    // 基础CRUD方法（RuoYi风格）
    AppUser selectAppUserById(Long userId);
    
    List<AppUser> selectAppUserList(AppUser appUser);
    
    int insertAppUser(AppUser appUser);
    
    int updateAppUser(AppUser appUser);
    
    int deleteAppUserById(Long userId);
    
    // 复杂查询使用XML
    List<AppUser> selectUsersByCondition(@Param("status") Integer status);
}
```

---

## 七、配置文件结构

### 7.1 配置文件层级

```
resources/
├── application.yml              # 主配置文件
├── application-dev.yml          # 开发环境配置
├── application-dev_template.yml # 开发环境配置模板（敏感信息占位，不提交；本地可复制为 application-dev.yml）
├── application-test.yml        # 测试环境配置（按需添加）
├── application-prod.yml        # 生产环境配置（按需添加）
├── logback-spring.xml           # 日志配置（可选）
└── mapper/                      # MyBatis Mapper XML
```

### 7.2 配置文件内容结构

**application.yml**（主配置）：
```yaml
spring:
  application:
    name: user-service
  profiles:
    active: dev
  # 其他公共配置
```

**application-dev.yml**（开发环境）：
```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/test_db
    username: root
    password: ${DB_PASSWORD:dev_password}
  redis:
    host: localhost
    port: 6379
```

**application-prod.yml**（生产环境）：
```yaml
spring:
  datasource:
    url: jdbc:mysql://${DB_HOST:localhost}:3306/${DB_NAME:prod_db}
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
  redis:
    host: ${REDIS_HOST}
    port: ${REDIS_PORT:6379}
```

### 7.3 配置管理原则

- 敏感信息使用环境变量
- 不同环境使用不同配置文件
- 公共配置放在主配置文件
- 环境特定配置放在对应环境配置文件

---

## 八、依赖关系

### 8.1 模块依赖关系

```
ruoyi-gateway
    └── ruoyi-common-security
            └── ruoyi-common-redis
                    └── ruoyi-common-core

ruoyi-auth (管理端认证)
    └── ruoyi-common-security
            └── ruoyi-common-redis
                    └── ruoyi-common-core

ruoyi-auth-app (业务端认证) ⭐ 新增
    └── ruoyi-common-security
            └── ruoyi-common-redis
                    └── ruoyi-common-core

ruoyi-system (系统服务)
    └── ruoyi-api-system
            └── ruoyi-common-security
                    └── ruoyi-common-core

ruoyi-content (内容服务) ⭐ 待创建
    └── ruoyi-common-security
            └── ruoyi-common-redis
                    └── ruoyi-common-core
```

### 8.2 依赖原则

- 公共模块不依赖业务服务
- 业务服务可以依赖公共模块
- 网关可以依赖公共模块
- 业务服务之间不直接依赖，通过Feign调用
- 业务端模块与管理端模块隔离，不互相依赖

---

## 九、代码生成规范

### 9.1 实体类生成

- 使用 RuoYi-Cloud 内置的代码生成服务（ruoyi-gen）
- 或手动编写实体类
- 实体类使用Lombok简化代码

### 9.2 统一代码模板

- Controller模板
- Service模板
- Mapper模板
- DTO/VO模板

---

## 十、注意事项

### 10.1 包结构注意事项

- 严格按照包结构组织代码
- 不要跨层调用（如Controller直接调用DAO）
- 公共代码放在common模块

### 10.2 命名注意事项

- 命名要有意义，见名知意
- 避免使用缩写（除非是通用缩写）
- 保持命名一致性

### 10.3 目录结构注意事项

- 每个服务保持相同的目录结构
- 新增模块时参考现有结构
- 保持代码组织清晰

---

*本文档定义了项目的模块与目录结构。*
