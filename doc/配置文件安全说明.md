# 配置文件安全说明

## 一、配置文件管理策略

### 1.1 模板文件机制

项目中所有包含敏感信息的配置文件都采用**模板文件**机制：

- **模板文件**：以 `_template.yml` 结尾，提交到 Git 仓库
- **实际配置文件**：复制模板文件后重命名，**不提交到 Git**

### 1.2 文件命名规范

```
application-dev_template.yml    # 模板文件（Git跟踪）
application-dev.yml            # 实际文件（Git忽略）
```

---

## 二、需要保护的敏感信息

以下信息**绝对不能**提交到 Git：

- ✅ **数据库密码**：`DB_PASSWORD`
- ✅ **Redis 密码**：`REDIS_PASSWORD`
- ✅ **RabbitMQ 密码**：`RABBITMQ_PASSWORD`
- ✅ **JWT 密钥**：`JWT_SECRET`
- ✅ **Elasticsearch 密码**：`ELASTICSEARCH_PASSWORD`
- ✅ **第三方 API 密钥**
- ✅ **生产环境配置**

---

## 三、使用方式

### 3.1 首次配置

1. **复制模板文件**：
   ```bash
   # 在对应模块的 resources 目录下
   cp application-dev_template.yml application-dev.yml
   ```

2. **修改敏感信息**：
   - 编辑 `application-dev.yml`
   - 替换所有占位符（如 `your-database-password`）
   - 或使用环境变量

3. **验证配置**：
   ```bash
   # 确保文件在 .gitignore 中
   git status
   # application-dev.yml 不应该出现在未跟踪文件中
   ```

### 3.2 使用环境变量（推荐）

在模板文件中，敏感信息已配置为使用环境变量：

```yaml
spring:
  datasource:
    password: ${DB_PASSWORD:your-database-password}
```

**方式一：系统环境变量**
```bash
export DB_PASSWORD=your-actual-password
export JWT_SECRET=your-actual-secret
```

**方式二：.env 文件**（已配置 Git 忽略）
```bash
# 在项目根目录创建 .env 文件
DB_PASSWORD=your-actual-password
JWT_SECRET=your-actual-secret
```

**方式三：IDEA 运行配置**
- `Run -> Edit Configurations`
- 添加 Environment variables

---

## 四、配置文件列表

### 4.1 需要创建模板的配置文件

| 文件路径 | 模板文件 | 说明 |
|---------|---------|------|
| `gateway/api-gateway/.../application-dev.yml` | ✅ 已创建 | 网关开发环境配置 |
| `services/*/.../application-dev.yml` | ✅ 已创建 | 各服务开发环境配置 |
| `common/common-security/.../application-security.yml` | ✅ 已创建 | JWT 安全配置 |

### 4.2 不需要模板的配置文件

以下文件**不包含敏感信息**，可以直接提交：

- ✅ `application.yml` - 基础配置（端口、应用名等）
- ✅ `application-mybatis.yml` - MyBatis 配置（无敏感信息）
- ✅ `logback-spring.xml` - 日志配置

---

## 五、Git 忽略规则

`.gitignore` 中已配置以下规则：

```gitignore
# 忽略包含敏感信息的配置文件
**/application-dev.yml
**/application-prod.yml
**/application-test.yml
**/application-local.yml
**/application-security.yml

# 但保留模板文件
!**/application-*_template.yml
!**/application.yml
```

---

## 六、安全检查清单

在提交代码前，请确认：

- [ ] 所有 `application-dev.yml` 文件已添加到 `.gitignore`
- [ ] 没有在代码中硬编码密码或密钥
- [ ] 模板文件中的占位符已替换为环境变量
- [ ] `.env` 文件已添加到 `.gitignore`
- [ ] 生产环境配置未提交到仓库

---

## 七、团队协作

### 7.1 新成员加入

1. **克隆项目**后，复制模板文件：
   ```bash
   find . -name "*_template.yml" -exec sh -c 'cp "$1" "${1%_template.yml}.yml"' _ {} \;
   ```

2. **配置环境变量**或修改配置文件

3. **验证配置**是否正确

### 7.2 配置更新

如果模板文件更新了：

1. **查看差异**：
   ```bash
   git diff application-dev_template.yml
   ```

2. **手动合并**到本地配置文件：
   ```bash
   # 使用 diff 工具对比
   diff application-dev_template.yml application-dev.yml
   ```

---

## 八、最佳实践

### 8.1 开发环境

- ✅ 使用 `.env` 文件管理敏感信息
- ✅ 配置文件使用环境变量引用
- ✅ 定期检查 `.gitignore` 是否生效

### 8.2 生产环境

- ✅ **必须**使用环境变量或配置中心（如 Nacos）
- ✅ **禁止**在配置文件中硬编码密码
- ✅ 使用密钥管理服务（如 Vault、AWS Secrets Manager）

### 8.3 CI/CD

- ✅ 在 CI/CD 平台配置环境变量
- ✅ 使用密钥管理功能
- ✅ 不在构建日志中输出敏感信息

---

## 九、常见问题

### Q1: 如何确认配置文件已被 Git 忽略？

```bash
git status
# 如果 application-dev.yml 没有出现在未跟踪文件中，说明已忽略
```

### Q2: 如果误提交了敏感配置文件怎么办？

```bash
# 1. 立即从 Git 历史中删除
git rm --cached path/to/application-dev.yml

# 2. 提交删除操作
git commit -m "Remove sensitive config file"

# 3. 如果已推送到远程，需要强制推送（谨慎！）
# git push --force

# 4. 更改所有泄露的密码和密钥
```

### Q3: 如何批量创建配置文件？

```bash
# 在项目根目录执行
find code -name "*_template.yml" | while read template; do
  actual="${template%_template.yml}.yml"
  if [ ! -f "$actual" ]; then
    cp "$template" "$actual"
    echo "Created: $actual"
  fi
done
```

---

## 十、参考文档

- [Spring Boot 外部化配置](https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.external-config)
- [OWASP 安全配置指南](https://owasp.org/www-project-web-security-testing-guide/)
- [Git 忽略文件最佳实践](https://git-scm.com/docs/gitignore)
